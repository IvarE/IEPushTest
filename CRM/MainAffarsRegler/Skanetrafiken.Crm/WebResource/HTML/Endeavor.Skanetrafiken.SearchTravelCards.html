<html>
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
    <link href="../css/Endeavor.Skanetrafiken.SearchTravelCards.css" rel="stylesheet" type="text/css">
    <script src="../script/Endeavor.Skanetrafiken.formscriptfunctions.js"></script>

    <script type="text/javascript">

        function blockTravelCardWithConfirmDialog() {
            var confirmStrings = { text: "Vill du verkligen spärra detta Jojokort?", title: "Spära Jojokort" };
            var confirmOptions = { height: 200, width: 450 };
            return window.parent.Xrm.Navigation.openConfirmDialog(confirmStrings, confirmOptions).then(
                function (success) {
                    if (success.confirmed) {
                        Endeavor.Skanetrafiken.SearchTravelCards.blockButtonPlaceCaptureOrder();
                    }
                });
        }

        function deactivateCloseButton() {
            document.getElementById("block").disabled = true;
        }

        function activateCloseButton() {
            document.getElementById("block").disabled = false;
        }

        function clearMessageField() {
            document.getElementById("messageSpace").innerText = "";
        }

        // Begin scoping
        if (typeof (Endeavor) == "undefined") {
            var Endeavor = {
            };
        }

        if (typeof (Endeavor.Skanetrafiken) == "undefined") {
            Endeavor.Skanetrafiken = {
            };
        }

        if (typeof (Endeavor.Skanetrafiken.SearchTravelCards) == "undefined") {
            Endeavor.Skanetrafiken.SearchTravelCards = {

                getInfoFromCardId: function () {
                    try {
                        var cardId = document.getElementById("cardId").value;

                        if (cardId == null || cardId == "") {
                            document.getElementById("messageSpace").innerText = "Kortnummer är noll eller tomt.";
                            return;
                        }

                        var inputParameters = [{ "Field": "CardNumber", "Value": cardId, "TypeName": Endeavor.formscriptfunctions.getParameterType("string"), "StructuralProperty": 1 }];

                        Endeavor.formscriptfunctions.callGlobalAction("ed_GetCard", inputParameters,
                            function (result) {
                                result = JSON.parse(result.responseText);
                                var cardNumberResp = result.CardNumberResp;
                                var isClosed = result.IsClosed;
                                var amount = result.Amount;
                                var closedReason = result.ClosedReason;
                                var isReserved = result.IsReserved;

                                if (isClosed) {
                                    document.getElementById("isBlockedYes").style.display = "block";
                                    document.getElementById("isBlockedNo").style.display = "none";
                                    deactivateCloseButton();
                                } else {
                                    document.getElementById("isBlockedYes").style.display = "none";
                                    document.getElementById("isBlockedNo").style.display = "block";
                                    activateCloseButton();
                                }

                                //document.getElementById("arsparrat").checked = isClosed;
                                document.getElementById("belopp").innerText = amount + " kr";
                                document.getElementById("sparradav").innerText = closedReason;
                                document.getElementById("reserveread").checked = isReserved;

                                //if (amount > 0 || isClosed)
                                //    activateCloseButton();
                            },
                            function (error) {
                                var errorMessage = "";
                                if (error.message.includes("404")) {
                                    errorMessage = "JoJo-kort med kortnummer: " + cardId +" saknas.";

                                } else {
                                    errorMessage = "Något gick fel. Vänligen försök igen. Details: " + error.message;
                                }
                                
                                console.error(errorMessage);
                                Endeavor.formscriptfunctions.AlertCustomDialog(errorMessage);
                            });
                    }
                    catch (error) {
                        console.log("Oväntat fel: " + error.message);
                        document.getElementById("messageSpace").innerText = ("Oväntat fel: " + error.message);
                    }
                },

                blockButtonPlaceCaptureOrder: function () {
                    try {
                        var cardId = document.getElementById("cardId").value;

                        if (cardId == null || cardId == "") {
                            document.getElementById("messageSpace").innerText = "Ange kortnummer";
                            return;
                        }

                        var inputParameters = [{ "Field": "CardNumber", "Value": cardId, "TypeName": Endeavor.formscriptfunctions.getParameterType("string"), "StructuralProperty": 1 }];

                        Endeavor.formscriptfunctions.callGlobalAction("ed_PlaceOrder", inputParameters,
                            function (result) {
                                result = JSON.parse(result.responseText);

                                var cardNumberResp = result.CardNumberResp;
                                var placeOrderResponse = result.PlaceOrderResponse;
                                var isClosed = result.IsClosed;
                                var amount = result.Amount;
                                var closedReason = result.ClosedReason;
                                var isReserved = result.IsReserved;

                                if (placeOrderResponse.indexOf("200") > -1)
                                    document.getElementById("messageSpace").innerText = "Kortet är spärrat";
                                else
                                    document.getElementById("messageSpace").innerText = placeOrderResponse;

                                if (isClosed) {
                                    document.getElementById("isBlockedYes").style.display = "block";
                                    document.getElementById("isBlockedNo").style.display = "none";
                                    deactivateCloseButton();
                                } else {
                                    document.getElementById("isBlockedYes").style.display = "none";
                                    document.getElementById("isBlockedNo").style.display = "block";
                                }

                                //document.getElementById("arsparrat").checked = isClosed;
                                document.getElementById("belopp").innerText = amount;
                                document.getElementById("sparradav").innerText = closedReason;
                                document.getElementById("reserveread").checked = isReserved;

                                Endeavor.formscriptfunctions.callGlobalAction("ed_CaptureOrder", inputParameters,
                                    function (result) {
                                        result = JSON.parse(result.responseText);
                                        var captureOrderResponse = result.CaptureOrderResponse;

                                        if (placeOrderResponse.indexOf("200") > -1)
                                            document.getElementById("messageSpace").innerText = "Kortet är spärrat";
                                        else
                                            document.getElementById("messageSpace").innerText = captureOrderResponse;

                                        document.getElementById("belopp").innerText = "0 kr";
                                        deactivateCloseButton();

                                        if (isClosed == true) {
                                            document.getElementById("isBlockedYes").style.display = "block";
                                            document.getElementById("isBlockedNo").style.display = "none";
                                        } else {
                                            document.getElementById("isBlockedYes").style.display = "none";
                                            document.getElementById("isBlockedNo").style.display = "block";
                                        }
                                    },
                                    function (error) {
                                        var errorMessage = "Något gick fel. Vänligen försök igen.";
                                        document.getElementById("messageSpace").innerText = errorMessage;
                                        console.error(errorMessage);
                                        //Endeavor.formscriptfunctions.AlertCustomDialog(errorMessage);
                                    });
                            },
                            function (error) {
                                var errorMessage = "Något gick fel. Vänligen försök igen.";
                                document.getElementById("messageSpace").innerText = errorMessage;
                                console.error(errorMessage);
                                //Endeavor.formscriptfunctions.AlertCustomDialog(errorMessage);
                            });
                    }
                    catch (error) {
                        document.getElementById("messageSpace").innerText = ("Oväntat fel: " + error.message);
                    }
                }
            };
        }


    </script>

    <meta>
</head>
<body style="overflow-wrap: break-word;">

    <div class="header-grid">
        <div class="row row-position no-border" style="--row: 1; --col: 1" id="headerLabel">Sök Jojo-kort</div>
        <div class="row row-position no-border" style="--row: 2; --col: 1"><input style="width:100%;" type="text" id="cardId"></div>
        <div class="row row-position content-bucket no-border" style="--row: 2; --col: 2" id="messageSpace"></div>
    </div>

    <hr style="width:100%;text-align:left;margin-left:20px;margin-bottom: 10px;">

    <div class="grid">
        <div class="row row-position content-bucket" style="--row: 1; --col: 1">Belopp:</div>
        <div class="row row-position content-bucket" style="--row: 1; --col: 2" id="belopp">-</div>

        <div class="row row-position content-bucket" style="--row: 2; --col: 1">Är spärrat:</div>
        <div class="row row-position content-bucket" style="--row: 2; --col: 2">
            <p id="isBlockedYes" style="display: none">Ja</p>
            <p id="isBlockedNo">Nej</p>
        </div>

        <div class="row row-position content-bucket" style="--row: 3; --col: 1">Spärrad av:</div>
        <div class="row row-position content-bucket" style="--row: 3; --col: 2" id="sparradav"></div>

        <div class="row row-position content-bucket no-border" style="--row: 4; --col: 1; display: none;">Reserverad:</div>
        <div class="row row-position content-bucket no-border" style="--row: 4; --col: 2"><input type="checkbox" id="reserveread" style="display: none;"></div>

        <div class="row row-position no-border" style="--row: 5; --col: 1"><button onclick="blockTravelCardWithConfirmDialog()" id="block" type="button" disabled="">Spärra Kort</button></div>
    </div>

    <script>
        document.getElementById("cardId").addEventListener('keydown', function (event) {
            if (event.key === 'Enter') {
                clearMessageField();
                Endeavor.Skanetrafiken.SearchTravelCards.getInfoFromCardId();
            }
        });
    </script>
</body>
</html>