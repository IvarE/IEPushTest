<html>
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
    <link href="../css/Endeavor.Skanetrafiken.SearchTravelCards.css" rel="stylesheet" type="text/css" />

    <script type="text/javascript">

        // Begin scoping
        if (typeof (Endeavor) == "undefined") {
            var Endeavor = {
            };
        }

        if (typeof (Endeavor.Skanetrafiken) == "undefined") {
            Endeavor.Skanetrafiken = {
            };
        }

        if (typeof (Endeavor.Skanetrafiken.SearchTravelCards) == "undefined") {
            Endeavor.Skanetrafiken.SearchTravelCards = {

                getInfoFromCardId: function () {

                    debugger;
                    try {

                        var cardId = document.getElementById("cardId").value;

                        if (cardId == null || cardId == "") {
                            document.getElementById("messageSpace").innerText = "Kortnummer är noll eller tomt.";
                            return;
                        }

                        var inputParameters = [{ "Field": "CardNumber", "Value": cardId, "TypeName": Endeavor.formscriptfunctions.getParameterType("string"), "StructuralProperty": 1 }];

                        Endeavor.formscriptfunctions.callGlobalAction("ed_GetCard", inputParameters,
                            function (result) {

                                debugger;
                                var cardNumberResp = result.CardNumberResp;
                                var isClosed = result.IsClosed;
                                var amount = result.Amount;
                                var closedReason = result.ClosedReason;
                                var isReserved = result.IsReserved;

                                if (isClosed) {
                                    document.getElementById("isBlockedYes").style.display = "block";
                                    document.getElementById("isBlockedNo").style.display = "none";
                                } else {
                                    document.getElementById("isBlockedYes").style.display = "none";
                                    document.getElementById("isBlockedNo").style.display = "block";
                                }

                                //document.getElementById("arsparrat").checked = isClosed;
                                document.getElementById("belopp").innerText = amount + " kr";
                                document.getElementById("sparradav").innerText = closedReason;
                                document.getElementById("reserveread").checked = isReserved;

                                if (amount > 0 || isClosed)
                                    document.getElementById("block").disabled = false;
                            },
                            function (error) {
                                var errorMessage = "Något gick fel. Vänligen försök igen. Details: " + error.message;
                                console.error(errorMessage);
                                Endeavor.formscriptfunctions.AlertCustomDialog(errorMessage);
                            });
                    }
                    catch (error) {
                        console.log("Oväntat fel: " + error.message);
                        document.getElementById("messageSpace").innerText = ("Oväntat fel: " + error.message);
                    }
                },

                blockButtonPlaceCaptureOrder: function () {

                    debugger;
                    try {

                        var cardId = document.getElementById("cardId").value;

                        if (cardId == null || cardId == "") {
                            document.getElementById("messageSpace").innerText = "Ange kortnummer";
                            return;
                        }

                        var inputParameters = [{ "Field": "CardNumber", "Value": cardId, "TypeName": Endeavor.formscriptfunctions.getParameterType("string"), "StructuralProperty": 1 }];

                        Endeavor.formscriptfunctions.callGlobalAction("ed_PlaceOrder", inputParameters,
                            function (result) {

                                debugger;
                                var cardNumberResp = result.CardNumberResp;
                                var placeOrderResponse = result.PlaceOrderResponse;
                                var isClosed = result.IsClosed;
                                var amount = result.Amount;
                                var closedReason = result.ClosedReason;
                                var isReserved = result.IsReserved;

                                if (placeOrderResponse.indexOf("200") > -1)
                                    document.getElementById("messageSpace").innerText = "Kortet är spärrat";
                                else
                                    document.getElementById("messageSpace").innerText = placeOrderResponse;

                                if (isClosed) {
                                    document.getElementById("isBlockedYes").style.display = "block";
                                    document.getElementById("isBlockedNo").style.display = "none";
                                } else {
                                    document.getElementById("isBlockedYes").style.display = "none";
                                    document.getElementById("isBlockedNo").style.display = "block";
                                }

                                //document.getElementById("arsparrat").checked = isClosed;
                                document.getElementById("belopp").innerText = amount;
                                document.getElementById("sparradav").innerText = closedReason;
                                document.getElementById("reserveread").checked = isReserved;

                                Endeavor.formscriptfunctions.callGlobalAction("ed_CaptureOrder", inputParameters,
                                    function (result) {

                                        debugger;
                                        var captureOrderResponse = result.CaptureOrderResponse;

                                        if (placeOrderResponse.indexOf("200") > -1)
                                            document.getElementById("messageSpace").innerText = "Kortet är spärrat";
                                        else
                                            document.getElementById("messageSpace").innerText = captureOrderResponse;

                                        document.getElementById("belopp").innerText = "0 kr";
                                        document.getElementById("block").disabled = true;

                                        if (isClosed == true) {
                                            document.getElementById("isBlockedYes").style.display = "block";
                                            document.getElementById("isBlockedNo").style.display = "none";
                                        } else {
                                            document.getElementById("isBlockedYes").style.display = "none";
                                            document.getElementById("isBlockedNo").style.display = "block";
                                        }
                                    },
                                    function (error) {
                                        var errorMessage = "Något gick fel. Vänligen försök igen. Details: " + error.message;
                                        console.error(errorMessage);
                                        Endeavor.formscriptfunctions.AlertCustomDialog(errorMessage);
                                    });
                            },
                            function (error) {
                                var errorMessage = "Något gick fel. Vänligen försök igen. Details: " + error.message;
                                console.error(errorMessage);
                                Endeavor.formscriptfunctions.AlertCustomDialog(errorMessage);
                            });
                    }
                    catch (error) {
                        document.getElementById("messageSpace").innerText = ("Oväntat fel: " + error.message);
                    }
                }
            };
        }

    </script>

</head>
<body>

    <div class="container">

        <div class="row">
            <div class="col-1"><div class="label" id="headerLabel">Sök Jojo-kort:</div></div>
            <div class="col-2"><input style="width:100%;" type="text" id="cardId"></div>
            <div class="col-1"><button onclick="Endeavor.Skanetrafiken.SearchTravelCards.getInfoFromCardId()" id="searchBtn" type="button" style="width:50px;margin-left:5px;">Sök</button></div>
            <div class="col-3" id="messageSpace"></div>
        </div>

        <hr style="width:100%;text-align:left;margin-left:0;margin-bottom: 10px;">

        <div class="row">
            <div class="col-2"><div class="label">Belopp:</div><div class="info" id="belopp"></div></div>
            <div class="col-2"></div>
            <div class="col-2"></div>
            <div class="col-2"></div>
            <div class="col-2"></div>
            <div class="col-2"></div>
        </div>

        <div class="row">
            <div class="col-2">
                <div class="label">Är Spärrat:</div>
                <!--<input type="radio" id="isBlockedYes" name="isBlocked" value="Nej" checked />
                <input type="radio" id="isBlockedNo" name="isBlocked" value="Ja" />-->
            </div>
            <div class="col-2">
                <p id="isBlockedYes" style="display: none">Ja</p>
                <p id="isBlockedNo">Nej</p>
            </div>
            <!--<div class="col-2"><div class="label">Är Spärrat:</div><input type="checkbox" id="arsparrat" /></div>-->
            <div class="col-2"></div>
            <div class="col-2"></div>
            <div class="col-2"></div>
            <div class="col-2"></div>
            <div class="col-2"></div>
        </div>

        <div class="row">
            <div class="col-2"><div class="label">Spärrad av:</div><div class="info" id="sparradav"></div></div>
            <div class="col-2"></div>
            <div class="col-2"></div>
            <div class="col-2"></div>
            <div class="col-2"></div>
            <div class="col-2"></div>
        </div>

        <div class="row">
            <div class="col-2"><div class="label" style="display: none;">Reserverad:</div><input type="checkbox" id="reserveread" style="display: none;" /></div>
            <div class="col-2"><button onclick="Endeavor.Skanetrafiken.SearchTravelCards.blockButtonPlaceCaptureOrder()" id="block" type="button" disabled>SPÄRRA KORT</button></div>
            <div class="col-2"></div>
            <div class="col-2"></div>
            <div class="col-2"></div>
            <div class="col-2"></div>
            <div class="col-2"></div>
        </div>

    </div>

</body>
</html>